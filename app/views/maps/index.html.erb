<div class="row mt-3">
  <%= form_with(url: maps_path, method: :get, local: true, class: "column filter-form") do |form|  %>

    <div data-controller="collapsible">
      <%= render partial: "date_controls", locals: {name: "Day of year", form: form}  %>
      <%= render partial: "date_range_controls", locals: {name: "Date range", form: form}  %>
      <%= render partial: "area_checkboxes", locals: {area: @cities, name: "city", form: form}  %>
      <%= render partial: "area_checkboxes", locals: {area: @states, name: "state", form: form}  %>
      <%= render partial: "area_checkboxes", locals: {area: @countries, name: "country", form: form}  %>
      <%= render partial: "albums_checkboxes", locals: {albums: @albums, name: "my albums", form: form}  %>
      <%= render partial: "albums_checkboxes", locals: {albums: @shared_albums, name: "albums shared with me", form: form}  %>

      <%= form.submit("Filter", class: "btn btn--primary mt-3")  %>
    </div>
  <% end %>

  <div id="map" data-controller="map">refresh page to view map</div>
</div>

<ul class="row">
  <% if @photos.present?  %>
    <% @photos.each do |photo|  %>
      <li class="column" data-controller="map" data-map-latitude="<%= photo.latitude_in_decimal  %>" data-map-longitude="<%= photo.longitude_in_decimal  %>" data-map-id="<%=  photo.id  %>" data-action="click->map#center">
        <%= image_tag(photo.image.variant(resize: '200x200')) if photo.image.attached? %>
        <%= link_to "View", photo_path(photo), class: "btn btn--secondary btn__inline"  %>
      </li>
    <% end %>
    <% else  %>
      <p class="warning"> No results</p>
  <% end %>

</ul>


<script src="https://maps.googleapis.com/maps/api/js?key=<%= Rails.application.credentials.maps_api_key  %>&callback=initMap&libraries=&v=weekly" defer ></script>

<script>
  <%# TODO: check for nil state on @photos because an empty album can still return a nil result %>
  var map;
  function initMap(){
      let latitude = 0
      let longitude = 0
      <% if @photos.present?  %>
      latitude =  <%= @photos.first.latitude_in_decimal %>
      longitude  =  <%= @photos.first.longitude_in_decimal %>
    <% end %>
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: latitude , lng: longitude  },
      zoom: 12,
    })
  }

  var MapData = { }

  MapData.getData = function(){
    let output = []
      <% @photos.each_with_index do |photo, index|  %>

        var item = {
          lat: <%= photo.latitude_in_decimal  %>,
          long: <%= photo.longitude_in_decimal  %>,
          url: '<%= rails_representation_url(photo.image.variant(resize: '200x200'), disposition: "attachment", only_path: true)   %>',
          id: <%= photo.id  %>
        }
    output.push(item)

    <% end %>
      return output
  }
  MapData.getMap = function(){
    return map}

  window.MapData = MapData
</script>
